package core

import (
	"encoding/json"
	"fmt"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/tez-capital/tezpay/common"
	"github.com/tez-capital/tezpay/configuration"
	"github.com/tez-capital/tezpay/state"
	"github.com/tez-capital/tezpay/test/mock"
	"github.com/tez-capital/tezpay/utils"
	"github.com/trilitech/tzgo/tezos"
)

type mockGenerateCollector struct {
	mock.EmptyCollector
}

func (engine *mockGenerateCollector) GetId() string {
	return "mockGenerateCollector"
}

func (engine *mockGenerateCollector) IsRevealed(address tezos.Address) (bool, error) {
	return true, nil
}

func (engine *mockGenerateCollector) GetCycleStakingData(baker tezos.Address, cycle int64) (*common.BakersCycleData, error) {
	rawCycleData := `{"OwnDelegatedBalance":"275708698","ExternalDelegatedBalance":"49100747788","BlockDelegatedRewards":"1197688","IdealBlockDelegatedRewards":"1197688","AttestationsDelegatedRewards":"1920302","IdealAttestationsDelegatedRewards":"1920302","DalDelegatedRewards":"427318","IdealDalDelegatedRewards":"427318","BlockDelegatedFees":"17100","DelegatorsCount":57,"OwnStakedBalance":"16421212933","ExternalStakedBalance":"29383795329","BlockStakingRewardsEdge":"192434","AttestationStakingRewardsEdge":"308534","BlockStakingFees":"0","StakersCount":8,"FrozenDepositLimit":"7300000000","Delegators":[{"Address":"tz1dKeXpumUQD5aCgk3jb7i7psWiRkzqJQdE","DelegatedBalance":"18996459719","StakedBalance":"0","Emptied":false},{"Address":"tz1WZRZ6ciwRvkx5YVe5uVXKxrnzDQQevFCL","DelegatedBalance":"16995702660","StakedBalance":"0","Emptied":false},{"Address":"tz1WpPaE47vtUT56MZGgKVi4VQCgEF95mvng","DelegatedBalance":"6704943203","StakedBalance":"0","Emptied":false},{"Address":"tz2X42QzdRqoqeKCqZaGpoXD4VmzmwbuMJMb","DelegatedBalance":"2067404437","StakedBalance":"0","Emptied":false},{"Address":"tz1PABDPXbg9rqz62umCaQ8YhCUajmoYK2Cb","DelegatedBalance":"767347858","StakedBalance":"0","Emptied":false},{"Address":"tz1dhJPohjESC3zzRnaJH7krf5wZPwLm4oH7","DelegatedBalance":"664759189","StakedBalance":"0","Emptied":false},{"Address":"tz1gnuBF9TbBcgHPV2mUE96tBrW7PxqRmx1h","DelegatedBalance":"598755901","StakedBalance":"0","Emptied":false},{"Address":"tz1UGkfyrT9yBt6U5PV7Qeui3pt3a8jffoWv","DelegatedBalance":"507845869","StakedBalance":"0","Emptied":false},{"Address":"tz1XS2hdV3ygveRn1gxRJZgJ4yxFK1YnRrLn","DelegatedBalance":"405103709","StakedBalance":"0","Emptied":false},{"Address":"tz1P9A1noGEeoAQ6WNYM87BbJ3iaioorrws2","DelegatedBalance":"313906924","StakedBalance":"0","Emptied":false},{"Address":"tz1eYiA2SFVBKPK2UW24puEzbTiLHxMDjVtj","DelegatedBalance":"170719784","StakedBalance":"0","Emptied":false},{"Address":"tz1X7U9XxVz6NDxL4DSZhijME61PW45bYUJE","DelegatedBalance":"165652388","StakedBalance":"0","Emptied":false},{"Address":"tz1WWvSczbkko8p14qknj6d1KiK4T3ckQ33X","DelegatedBalance":"161298995","StakedBalance":"0","Emptied":false},{"Address":"tz1gKDahpLhd85yuJ6TEFAwrcnmcEG9gTkSi","DelegatedBalance":"94164895","StakedBalance":"0","Emptied":false},{"Address":"tz2BZibvVaRzZq5kUWz1rcrJychdbHmoNZJE","DelegatedBalance":"75318303","StakedBalance":"0","Emptied":false},{"Address":"tz1cXDqHit4wsNv6dFHggKxDUBdpTkAaizyx","DelegatedBalance":"74317010","StakedBalance":"0","Emptied":false},{"Address":"tz2NvuB26dtjUg11Gb49uocbYrJf26zN2QqW","DelegatedBalance":"70644509","StakedBalance":"0","Emptied":false},{"Address":"tz1XyRgFTiNNZU7WzG3LDBi1bXWYPupBNBL2","DelegatedBalance":"50000001","StakedBalance":"0","Emptied":false},{"Address":"tz1dLZQyaopB2MDMdQC5nRt3Yx6RArVRubRh","DelegatedBalance":"34441415","StakedBalance":"0","Emptied":false},{"Address":"tz1gMRKQWdhY5ZPUehpHofLswyL8Vexvfpbm","DelegatedBalance":"32415471","StakedBalance":"0","Emptied":false},{"Address":"tz2Lhty58UJvywseQH9vpGasHjuHtiitKZ56","DelegatedBalance":"20256873","StakedBalance":"0","Emptied":false},{"Address":"tz1hVZBTeTs9GZtpShYYuF92f7F2g4gWSQo9","DelegatedBalance":"18888009","StakedBalance":"0","Emptied":false},{"Address":"tz1Nry5YPddf4VFDyunXLR8b8AtpvGJLMLZA","DelegatedBalance":"17427981","StakedBalance":"0","Emptied":false},{"Address":"tz1boUGNrp8Z1WEAkqTHAPr5DennP7tQjF71","DelegatedBalance":"14207578","StakedBalance":"0","Emptied":false},{"Address":"tz1Sf9KWCfjN3nsPHB4cek2MXBuXq5qjBZrs","DelegatedBalance":"12750656","StakedBalance":"0","Emptied":false},{"Address":"tz1frE7ArsC1spvQGizY5gBbJBtjnzGCgQ3y","DelegatedBalance":"11966885","StakedBalance":"0","Emptied":false},{"Address":"tz1hbseHXGm2XB7ivo1r3mbpH29c4GZE1aV2","DelegatedBalance":"11307149","StakedBalance":"0","Emptied":false},{"Address":"tz1f8LD3RZ9SMZUgsHQsQAX85EApD2cTXKES","DelegatedBalance":"10889299","StakedBalance":"0","Emptied":false},{"Address":"tz1dTmMLY7tan1HKfW5e3KxJcfZput6UuTH6","DelegatedBalance":"7355283","StakedBalance":"0","Emptied":false},{"Address":"tz1SRqikWtR2KNpugCApreA9QeZuqh8swQMa","DelegatedBalance":"5221495","StakedBalance":"0","Emptied":false},{"Address":"tz1iKqZc4CfrPwjcD7kx8MZtFtfL6YysKnPv","DelegatedBalance":"2939210","StakedBalance":"0","Emptied":false},{"Address":"tz2DWwmauKy4Dkak6X8ePY4Z91EsM36miYxB","DelegatedBalance":"1984760","StakedBalance":"0","Emptied":false},{"Address":"tz1aCb6QKL7K4JxRTUTYjAER8qZH4zKAbigq","DelegatedBalance":"1866216","StakedBalance":"0","Emptied":false},{"Address":"tz1f4zxfTtjTKkrzzXNtQU73zGBcasW3xEBS","DelegatedBalance":"1641573","StakedBalance":"0","Emptied":false},{"Address":"tz1TG2bxjvmRMQakt8KVQ5S6CyLzMuSHx2qF","DelegatedBalance":"1502458","StakedBalance":"0","Emptied":false},{"Address":"tz1YibTr9kUchgG6wJjMwRar2NUfawxH48FT","DelegatedBalance":"1459627","StakedBalance":"0","Emptied":false},{"Address":"tz1YtK9qUJffq2SqjhaJEGbufVHEBWDLPrSV","DelegatedBalance":"1425001","StakedBalance":"0","Emptied":false},{"Address":"tz2DTjmLqMXSwhkpCFnV977vyhtYWbsP6nwo","DelegatedBalance":"1406177","StakedBalance":"0","Emptied":false},{"Address":"tz1eaCp9cc4FtTs3Wm6UgZZnEtZ9b1Peqewi","DelegatedBalance":"1322354","StakedBalance":"0","Emptied":false},{"Address":"tz1MZ7ypArEoYocyyfscGaneNKM7bADhnQC4","DelegatedBalance":"990125","StakedBalance":"0","Emptied":false},{"Address":"tz1Qzov1LwEvSfHonRHr2EwQGto7ExrH43or","DelegatedBalance":"960009","StakedBalance":"0","Emptied":false},{"Address":"tz28e4LURT9Kv6TXysL6szWYkKKqRmA1wDGq","DelegatedBalance":"370571","StakedBalance":"0","Emptied":false},{"Address":"KT1AmQTRDjTwfJDASJRJZdd7uJwDqs5W2mjA","DelegatedBalance":"289285","StakedBalance":"0","Emptied":false},{"Address":"tz1UC8X57hKRmTbgJWsoos9njMy2SW3bKAAh","DelegatedBalance":"275000","StakedBalance":"0","Emptied":false},{"Address":"tz1XX6ykvpfPGAkzeDaFPvvPqmRQoTwCvP4S","DelegatedBalance":"200001","StakedBalance":"0","Emptied":false},{"Address":"tz1P91PPAfukVdpgj153WqoLymrWDYCoyLRA","DelegatedBalance":"172996","StakedBalance":"0","Emptied":false},{"Address":"KT1Kmai449TQT76GZXbihwNFHTUy432y1Z6Y","DelegatedBalance":"164629","StakedBalance":"0","Emptied":false},{"Address":"tz2JvpjaCGsynphe78Xbyu2kHUU2Ym8rxi8v","DelegatedBalance":"162848","StakedBalance":"0","Emptied":false},{"Address":"tz1YDHyB7aBCvj5TCYiRQkjeVHfgtEYUDAd2","DelegatedBalance":"63473","StakedBalance":"0","Emptied":false},{"Address":"tz1VWKeeSqxdLsTfAyCSrwFVZnfgw4ZwaHWV","DelegatedBalance":"40787","StakedBalance":"0","Emptied":false},{"Address":"tz1Xfkbwwa9ewNvYnesSXEYWGgS5gXVSQQVj","DelegatedBalance":"27475","StakedBalance":"0","Emptied":false},{"Address":"tz1Mv79qqYx2QX1NXYawrSrya13T7QoxCba9","DelegatedBalance":"8937","StakedBalance":"0","Emptied":false},{"Address":"KT19XE62UbrJ2gWW4ZWq2UxTQLhrnjBHLvBm","DelegatedBalance":"826","StakedBalance":"0","Emptied":false},{"Address":"tz2H4arakxXuzfo8NBVqTNgL5NBZ9b497Pfv","DelegatedBalance":"1","StakedBalance":"0","Emptied":false},{"Address":"tz1WxZvegEFTFSA8mqHWsBq97S15kS34JXqu","DelegatedBalance":"1","StakedBalance":"0","Emptied":false},{"Address":"KT1FtGbyLR1KV9oQGEYgBUpKPkEC8BcQn4cD","DelegatedBalance":"0","StakedBalance":"0","Emptied":false},{"Address":"KT1B5KPckWy2Mw99ii3wKuE4TQWKKQtSNXFE","DelegatedBalance":"0","StakedBalance":"0","Emptied":false}]}`
	var cycleData common.BakersCycleData
	err := json.Unmarshal([]byte(rawCycleData), &cycleData)
	if err != nil {
		panic(err)
	}
	return &cycleData, err
}

func Test_Generate(t *testing.T) {
	var err error
	assert := assert.New(t)

	state.Init(".", state.StateInitOptions{})
	rawConfig := `{
        tezpay_config_version: 0
        baker: tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM
        payouts: {
                fee: 0.11
                transaction_fee_buffer: 0
                kt_transaction_fee_buffer: 0
        }
        delegators: {
                requirements: {
                        minimum_balance: 10
                }
        }
        network: {
                rpc_pool: [
					https://eu.rpc.tez.capital/
					https://us.rpc.tez.capital/
                ]
                tzkt_url: https://api.tzkt.io/
        }
        overdelegation: {
                protect: true
        }
        income_recipients: {
                donate: 0.01
        }
        notifications: [
        ]
	}`

	config, _ := configuration.LoadFromString([]byte(rawConfig))
	assert.NotNil(config)

	collector := mockGenerateCollector{}
	signer := mock.InitSimpleSigner()

	engineContext := common.NewGeneratePayoutsEngines(&collector, signer, func(msg string) {})

	result, err := GeneratePayouts(config, engineContext, &common.GeneratePayoutsOptions{
		Cycle: 1016,
	})

	assert.Nil(err)
	assert.NotNil(result)
	fmt.Println(len(result.Payouts))

	rawExpectedResult := `{"cycles":1016,"payouts":[{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1dKeXpumUQD5aCgk3jb7i7psWiRkzqJQdE","cycle":1016,"recipient":"tz1dKeXpumUQD5aCgk3jb7i7psWiRkzqJQdE","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"18996459719","staked_balance":"0","amount":"1219794","fee_rate":0.11,"fee":"150761","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1WZRZ6ciwRvkx5YVe5uVXKxrnzDQQevFCL","cycle":1016,"recipient":"tz1WZRZ6ciwRvkx5YVe5uVXKxrnzDQQevFCL","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"16995702660","staked_balance":"0","amount":"1091322","fee_rate":0.11,"fee":"134882","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1WpPaE47vtUT56MZGgKVi4VQCgEF95mvng","cycle":1016,"recipient":"tz1WpPaE47vtUT56MZGgKVi4VQCgEF95mvng","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"6704943203","staked_balance":"0","amount":"430535","fee_rate":0.11,"fee":"53212","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz2X42QzdRqoqeKCqZaGpoXD4VmzmwbuMJMb","cycle":1016,"recipient":"tz2X42QzdRqoqeKCqZaGpoXD4VmzmwbuMJMb","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"2067404437","staked_balance":"0","amount":"132751","fee_rate":0.11,"fee":"16407","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1PABDPXbg9rqz62umCaQ8YhCUajmoYK2Cb","cycle":1016,"recipient":"tz1PABDPXbg9rqz62umCaQ8YhCUajmoYK2Cb","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"767347858","staked_balance":"0","amount":"49273","fee_rate":0.11,"fee":"6089","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1dhJPohjESC3zzRnaJH7krf5wZPwLm4oH7","cycle":1016,"recipient":"tz1dhJPohjESC3zzRnaJH7krf5wZPwLm4oH7","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"664759189","staked_balance":"0","amount":"42685","fee_rate":0.11,"fee":"5275","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1gnuBF9TbBcgHPV2mUE96tBrW7PxqRmx1h","cycle":1016,"recipient":"tz1gnuBF9TbBcgHPV2mUE96tBrW7PxqRmx1h","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"598755901","staked_balance":"0","amount":"38447","fee_rate":0.11,"fee":"4751","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1UGkfyrT9yBt6U5PV7Qeui3pt3a8jffoWv","cycle":1016,"recipient":"tz1UGkfyrT9yBt6U5PV7Qeui3pt3a8jffoWv","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"507845869","staked_balance":"0","amount":"32610","fee_rate":0.11,"fee":"4030","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1XS2hdV3ygveRn1gxRJZgJ4yxFK1YnRrLn","cycle":1016,"recipient":"tz1XS2hdV3ygveRn1gxRJZgJ4yxFK1YnRrLn","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"405103709","staked_balance":"0","amount":"26013","fee_rate":0.11,"fee":"3214","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1P9A1noGEeoAQ6WNYM87BbJ3iaioorrws2","cycle":1016,"recipient":"tz1P9A1noGEeoAQ6WNYM87BbJ3iaioorrws2","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"313906924","staked_balance":"0","amount":"20156","fee_rate":0.11,"fee":"2491","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1eYiA2SFVBKPK2UW24puEzbTiLHxMDjVtj","cycle":1016,"recipient":"tz1eYiA2SFVBKPK2UW24puEzbTiLHxMDjVtj","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"170719784","staked_balance":"0","amount":"10963","fee_rate":0.11,"fee":"1354","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1X7U9XxVz6NDxL4DSZhijME61PW45bYUJE","cycle":1016,"recipient":"tz1X7U9XxVz6NDxL4DSZhijME61PW45bYUJE","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"165652388","staked_balance":"0","amount":"10637","fee_rate":0.11,"fee":"1314","note":"RECIPIENT_TARGETS_PAYOUT"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1WWvSczbkko8p14qknj6d1KiK4T3ckQ33X","cycle":1016,"recipient":"tz1WWvSczbkko8p14qknj6d1KiK4T3ckQ33X","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"161298995","staked_balance":"0","amount":"10357","fee_rate":0.11,"fee":"1280","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1gKDahpLhd85yuJ6TEFAwrcnmcEG9gTkSi","cycle":1016,"recipient":"tz1gKDahpLhd85yuJ6TEFAwrcnmcEG9gTkSi","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"94164895","staked_balance":"0","amount":"6046","fee_rate":0.11,"fee":"747","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz2BZibvVaRzZq5kUWz1rcrJychdbHmoNZJE","cycle":1016,"recipient":"tz2BZibvVaRzZq5kUWz1rcrJychdbHmoNZJE","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"75318303","staked_balance":"0","amount":"4837","fee_rate":0.11,"fee":"597","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1cXDqHit4wsNv6dFHggKxDUBdpTkAaizyx","cycle":1016,"recipient":"tz1cXDqHit4wsNv6dFHggKxDUBdpTkAaizyx","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"74317010","staked_balance":"0","amount":"4772","fee_rate":0.11,"fee":"589","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz2NvuB26dtjUg11Gb49uocbYrJf26zN2QqW","cycle":1016,"recipient":"tz2NvuB26dtjUg11Gb49uocbYrJf26zN2QqW","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"70644509","staked_balance":"0","amount":"4536","fee_rate":0.11,"fee":"560","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1XyRgFTiNNZU7WzG3LDBi1bXWYPupBNBL2","cycle":1016,"recipient":"tz1XyRgFTiNNZU7WzG3LDBi1bXWYPupBNBL2","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"50000001","staked_balance":"0","amount":"3211","fee_rate":0.11,"fee":"396","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1dLZQyaopB2MDMdQC5nRt3Yx6RArVRubRh","cycle":1016,"recipient":"tz1dLZQyaopB2MDMdQC5nRt3Yx6RArVRubRh","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"34441415","staked_balance":"0","amount":"2211","fee_rate":0.11,"fee":"273","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1gMRKQWdhY5ZPUehpHofLswyL8Vexvfpbm","cycle":1016,"recipient":"tz1gMRKQWdhY5ZPUehpHofLswyL8Vexvfpbm","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"32415471","staked_balance":"0","amount":"2081","fee_rate":0.11,"fee":"257","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz2Lhty58UJvywseQH9vpGasHjuHtiitKZ56","cycle":1016,"recipient":"tz2Lhty58UJvywseQH9vpGasHjuHtiitKZ56","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"20256873","staked_balance":"0","amount":"1301","fee_rate":0.11,"fee":"160","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1hVZBTeTs9GZtpShYYuF92f7F2g4gWSQo9","cycle":1016,"recipient":"tz1hVZBTeTs9GZtpShYYuF92f7F2g4gWSQo9","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"18888009","staked_balance":"0","amount":"1213","fee_rate":0.11,"fee":"149","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1Nry5YPddf4VFDyunXLR8b8AtpvGJLMLZA","cycle":1016,"recipient":"tz1Nry5YPddf4VFDyunXLR8b8AtpvGJLMLZA","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"17427981","staked_balance":"0","amount":"1119","fee_rate":0.11,"fee":"138","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1boUGNrp8Z1WEAkqTHAPr5DennP7tQjF71","cycle":1016,"recipient":"tz1boUGNrp8Z1WEAkqTHAPr5DennP7tQjF71","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"14207578","staked_balance":"0","amount":"913","fee_rate":0.11,"fee":"112","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1Sf9KWCfjN3nsPHB4cek2MXBuXq5qjBZrs","cycle":1016,"recipient":"tz1Sf9KWCfjN3nsPHB4cek2MXBuXq5qjBZrs","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"12750656","staked_balance":"0","amount":"818","fee_rate":0.11,"fee":"101","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1frE7ArsC1spvQGizY5gBbJBtjnzGCgQ3y","cycle":1016,"recipient":"tz1frE7ArsC1spvQGizY5gBbJBtjnzGCgQ3y","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"11966885","staked_balance":"0","amount":"769","fee_rate":0.11,"fee":"94","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1hbseHXGm2XB7ivo1r3mbpH29c4GZE1aV2","cycle":1016,"recipient":"tz1hbseHXGm2XB7ivo1r3mbpH29c4GZE1aV2","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"11307149","staked_balance":"0","amount":"726","fee_rate":0.11,"fee":"89","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1f8LD3RZ9SMZUgsHQsQAX85EApD2cTXKES","cycle":1016,"recipient":"tz1f8LD3RZ9SMZUgsHQsQAX85EApD2cTXKES","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"10889299","staked_balance":"0","amount":"699","fee_rate":0.11,"fee":"86","valid":true},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1dTmMLY7tan1HKfW5e3KxJcfZput6UuTH6","cycle":1016,"recipient":"tz1dTmMLY7tan1HKfW5e3KxJcfZput6UuTH6","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"7355283","staked_balance":"0","amount":"472","fee_rate":0.11,"fee":"58","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1SRqikWtR2KNpugCApreA9QeZuqh8swQMa","cycle":1016,"recipient":"tz1SRqikWtR2KNpugCApreA9QeZuqh8swQMa","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"5221495","staked_balance":"0","amount":"335","fee_rate":0.11,"fee":"41","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1iKqZc4CfrPwjcD7kx8MZtFtfL6YysKnPv","cycle":1016,"recipient":"tz1iKqZc4CfrPwjcD7kx8MZtFtfL6YysKnPv","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"2939210","staked_balance":"0","amount":"189","fee_rate":0.11,"fee":"23","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz2DWwmauKy4Dkak6X8ePY4Z91EsM36miYxB","cycle":1016,"recipient":"tz2DWwmauKy4Dkak6X8ePY4Z91EsM36miYxB","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1984760","staked_balance":"0","amount":"128","fee_rate":0.11,"fee":"15","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1aCb6QKL7K4JxRTUTYjAER8qZH4zKAbigq","cycle":1016,"recipient":"tz1aCb6QKL7K4JxRTUTYjAER8qZH4zKAbigq","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1866216","staked_balance":"0","amount":"120","fee_rate":0.11,"fee":"14","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1f4zxfTtjTKkrzzXNtQU73zGBcasW3xEBS","cycle":1016,"recipient":"tz1f4zxfTtjTKkrzzXNtQU73zGBcasW3xEBS","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1641573","staked_balance":"0","amount":"106","fee_rate":0.11,"fee":"12","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1TG2bxjvmRMQakt8KVQ5S6CyLzMuSHx2qF","cycle":1016,"recipient":"tz1TG2bxjvmRMQakt8KVQ5S6CyLzMuSHx2qF","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1502458","staked_balance":"0","amount":"97","fee_rate":0.11,"fee":"11","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1YibTr9kUchgG6wJjMwRar2NUfawxH48FT","cycle":1016,"recipient":"tz1YibTr9kUchgG6wJjMwRar2NUfawxH48FT","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1459627","staked_balance":"0","amount":"94","fee_rate":0.11,"fee":"11","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1YtK9qUJffq2SqjhaJEGbufVHEBWDLPrSV","cycle":1016,"recipient":"tz1YtK9qUJffq2SqjhaJEGbufVHEBWDLPrSV","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1425001","staked_balance":"0","amount":"91","fee_rate":0.11,"fee":"11","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz2DTjmLqMXSwhkpCFnV977vyhtYWbsP6nwo","cycle":1016,"recipient":"tz2DTjmLqMXSwhkpCFnV977vyhtYWbsP6nwo","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1406177","staked_balance":"0","amount":"90","fee_rate":0.11,"fee":"11","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1eaCp9cc4FtTs3Wm6UgZZnEtZ9b1Peqewi","cycle":1016,"recipient":"tz1eaCp9cc4FtTs3Wm6UgZZnEtZ9b1Peqewi","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1322354","staked_balance":"0","amount":"85","fee_rate":0.11,"fee":"10","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1MZ7ypArEoYocyyfscGaneNKM7bADhnQC4","cycle":1016,"recipient":"tz1MZ7ypArEoYocyyfscGaneNKM7bADhnQC4","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"990125","staked_balance":"0","amount":"64","fee_rate":0.11,"fee":"7","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1Qzov1LwEvSfHonRHr2EwQGto7ExrH43or","cycle":1016,"recipient":"tz1Qzov1LwEvSfHonRHr2EwQGto7ExrH43or","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"960009","staked_balance":"0","amount":"62","fee_rate":0.11,"fee":"7","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz28e4LURT9Kv6TXysL6szWYkKKqRmA1wDGq","cycle":1016,"recipient":"tz28e4LURT9Kv6TXysL6szWYkKKqRmA1wDGq","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"370571","staked_balance":"0","amount":"24","fee_rate":0.11,"fee":"2","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"KT1AmQTRDjTwfJDASJRJZdd7uJwDqs5W2mjA","cycle":1016,"recipient":"KT1AmQTRDjTwfJDASJRJZdd7uJwDqs5W2mjA","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"289285","staked_balance":"0","amount":"18","fee_rate":0.11,"fee":"2","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1UC8X57hKRmTbgJWsoos9njMy2SW3bKAAh","cycle":1016,"recipient":"tz1UC8X57hKRmTbgJWsoos9njMy2SW3bKAAh","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"275000","staked_balance":"0","amount":"17","fee_rate":0.11,"fee":"2","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1XX6ykvpfPGAkzeDaFPvvPqmRQoTwCvP4S","cycle":1016,"recipient":"tz1XX6ykvpfPGAkzeDaFPvvPqmRQoTwCvP4S","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"200001","staked_balance":"0","amount":"13","fee_rate":0.11,"fee":"1","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1P91PPAfukVdpgj153WqoLymrWDYCoyLRA","cycle":1016,"recipient":"tz1P91PPAfukVdpgj153WqoLymrWDYCoyLRA","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"172996","staked_balance":"0","amount":"11","fee_rate":0.11,"fee":"1","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"KT1Kmai449TQT76GZXbihwNFHTUy432y1Z6Y","cycle":1016,"recipient":"KT1Kmai449TQT76GZXbihwNFHTUy432y1Z6Y","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"164629","staked_balance":"0","amount":"10","fee_rate":0.11,"fee":"1","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz2JvpjaCGsynphe78Xbyu2kHUU2Ym8rxi8v","cycle":1016,"recipient":"tz2JvpjaCGsynphe78Xbyu2kHUU2Ym8rxi8v","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"162848","staked_balance":"0","amount":"10","fee_rate":0.11,"fee":"1","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1YDHyB7aBCvj5TCYiRQkjeVHfgtEYUDAd2","cycle":1016,"recipient":"tz1YDHyB7aBCvj5TCYiRQkjeVHfgtEYUDAd2","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"63473","staked_balance":"0","amount":"4","fee_rate":0.11,"fee":"0","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1VWKeeSqxdLsTfAyCSrwFVZnfgw4ZwaHWV","cycle":1016,"recipient":"tz1VWKeeSqxdLsTfAyCSrwFVZnfgw4ZwaHWV","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"40787","staked_balance":"0","amount":"2","fee_rate":0.11,"fee":"0","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1Xfkbwwa9ewNvYnesSXEYWGgS5gXVSQQVj","cycle":1016,"recipient":"tz1Xfkbwwa9ewNvYnesSXEYWGgS5gXVSQQVj","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"27475","staked_balance":"0","amount":"1","fee_rate":0.11,"fee":"0","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1Mv79qqYx2QX1NXYawrSrya13T7QoxCba9","cycle":1016,"recipient":"tz1Mv79qqYx2QX1NXYawrSrya13T7QoxCba9","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"8937","staked_balance":"0","amount":"0","fee_rate":0.11,"fee":"0","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"KT19XE62UbrJ2gWW4ZWq2UxTQLhrnjBHLvBm","cycle":1016,"recipient":"KT19XE62UbrJ2gWW4ZWq2UxTQLhrnjBHLvBm","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"826","staked_balance":"0","amount":"0","fee_rate":0.11,"fee":"0","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz2H4arakxXuzfo8NBVqTNgL5NBZ9b497Pfv","cycle":1016,"recipient":"tz2H4arakxXuzfo8NBVqTNgL5NBZ9b497Pfv","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1","staked_balance":"0","amount":"0","fee_rate":0.11,"fee":"0","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"tz1WxZvegEFTFSA8mqHWsBq97S15kS34JXqu","cycle":1016,"recipient":"tz1WxZvegEFTFSA8mqHWsBq97S15kS34JXqu","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"1","staked_balance":"0","amount":"0","fee_rate":0.11,"fee":"0","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"KT1FtGbyLR1KV9oQGEYgBUpKPkEC8BcQn4cD","cycle":1016,"recipient":"KT1FtGbyLR1KV9oQGEYgBUpKPkEC8BcQn4cD","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"0","staked_balance":"0","amount":"0","fee_rate":0.11,"fee":"0","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"KT1B5KPckWy2Mw99ii3wKuE4TQWKKQtSNXFE","cycle":1016,"recipient":"KT1B5KPckWy2Mw99ii3wKuE4TQWKKQtSNXFE","kind":"delegator reward","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"0","staked_balance":"0","amount":"0","fee_rate":0.11,"fee":"0","note":"DELEGATOR_LOW_BALANCE"},{"baker":"tz1P6WKJu2rcbxKiKRZHKQKmKrpC9TfW1AwM","delegator":"","cycle":1016,"recipient":"tz1UGkfyrT9yBt6U5PV7Qeui3pt3a8jffoWv","kind":"donation","tx_kind":"tez","fa_token_id":"0","fa_contract":"","delegator_balance":"0","staked_balance":"0","amount":"4094","fee":"0","valid":true}],"own_staked_balance":"16421212933","own_delegated_balance":"275708698","external_staked_balance":"29383795329","external_delegated_balance":"49100747788","cycle_earned_fees":"17100","cycle_earned_rewards":"3545308","cycle_earned_total":"3562408","bond_income":"19693","fee_income":"385753","total_income":"405446","donated_bonds":"198","donated_fees":"3896","donated_total":"4094","timestamp":"2025-10-13T23:28:42.944885835+02:00"}`

	var expectedResult common.CyclePayoutBlueprint
	err = json.Unmarshal([]byte(rawExpectedResult), &expectedResult)
	assert.NoError(err)
	assert.Equal(len(expectedResult.Payouts), len(result.Payouts))

	utils.SortPayouts(expectedResult.Payouts)
	utils.SortPayouts(result.Payouts)
	for i, payout := range expectedResult.Payouts {
		if payout.Recipient == tezos.MustParseAddress("tz1X7U9XxVz6NDxL4DSZhijME61PW45bYUJE") {
			// skip address which was used to generate test data
			// this address was used to generate test data, we do not use it in tests
			// so if it is delegated to baker it would appear in result as RECIPIENT_TARGETS_PAYOUT
			// which can not be replicated in test data as we use a random payout address for tests
			continue
		}

		assert.Equal(expectedResult.Payouts[i].Baker, result.Payouts[i].Baker)
		assert.Equal(expectedResult.Payouts[i].Delegator, result.Payouts[i].Delegator)
		assert.Equal(expectedResult.Payouts[i].Cycle, result.Payouts[i].Cycle)
		assert.Equal(expectedResult.Payouts[i].Recipient, result.Payouts[i].Recipient)
		assert.Equal(expectedResult.Payouts[i].Kind, result.Payouts[i].Kind)
		assert.Equal(expectedResult.Payouts[i].TxKind, result.Payouts[i].TxKind)
		assert.Equal(expectedResult.Payouts[i].FATokenId, result.Payouts[i].FATokenId)
		assert.Equal(expectedResult.Payouts[i].FAContract, result.Payouts[i].FAContract)
		assert.Equal(expectedResult.Payouts[i].FAAlias, result.Payouts[i].FAAlias)
		assert.Equal(expectedResult.Payouts[i].FADecimals, result.Payouts[i].FADecimals)
		assert.Equal(expectedResult.Payouts[i].DelegatedBalance, result.Payouts[i].DelegatedBalance)
		assert.Equal(expectedResult.Payouts[i].StakedBalance, result.Payouts[i].StakedBalance)
		assert.Equal(expectedResult.Payouts[i].Amount, result.Payouts[i].Amount)
		assert.Equal(expectedResult.Payouts[i].FeeRate, result.Payouts[i].FeeRate)
		assert.Equal(expectedResult.Payouts[i].Fee, result.Payouts[i].Fee)
		assert.Equal(expectedResult.Payouts[i].TxFee, result.Payouts[i].TxFee)
		assert.Equal(expectedResult.Payouts[i].Note, result.Payouts[i].Note)
		assert.Equal(expectedResult.Payouts[i].IsValid, result.Payouts[i].IsValid)
	}
}
